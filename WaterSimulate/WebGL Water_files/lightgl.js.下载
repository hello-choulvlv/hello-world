var GL=function(){function t(){w.MODELVIEW=1|M,w.PROJECTION=2|M;var t=new s,e=new s;w.modelviewMatrix=new s,w.projectionMatrix=new s;var r,n,i=[],o=[];w.matrixMode=function(t){switch(t){case w.MODELVIEW:r="modelviewMatrix",n=i;break;case w.PROJECTION:r="projectionMatrix",n=o;break;default:throw new Error("invalid matrix mode "+t)}},w.loadIdentity=function(){s.identity(w[r])},w.loadMatrix=function(t){for(var e=t.m,n=w[r].m,i=0;i<16;i++)n[i]=e[i]},w.multMatrix=function(t){w.loadMatrix(s.multiply(w[r],t,e))},w.perspective=function(e,r,n,i){w.multMatrix(s.perspective(e,r,n,i,t))},w.frustum=function(e,r,n,i,o,a){w.multMatrix(s.frustum(e,r,n,i,o,a,t))},w.ortho=function(e,r,n,i,o,a){w.multMatrix(s.ortho(e,r,n,i,o,a,t))},w.scale=function(e,r,n){w.multMatrix(s.scale(e,r,n,t))},w.translate=function(e,r,n){w.multMatrix(s.translate(e,r,n,t))},w.rotate=function(e,r,n,i){w.multMatrix(s.rotate(e,r,n,i,t))},w.lookAt=function(e,r,n,i,o,a,u,f,c){w.multMatrix(s.lookAt(e,r,n,i,o,a,u,f,c,t))},w.pushMatrix=function(){n.push(Array.prototype.slice.call(w[r].m))},w.popMatrix=function(){var t=n.pop();w[r].m=b?new Float32Array(t):t},w.project=function(t,e,r,n,i,o){n=n||w.modelviewMatrix,i=i||w.projectionMatrix,o=o||w.getParameter(w.VIEWPORT);var a=i.transformPoint(n.transformPoint(new y(t,e,r)));return new y(o[0]+o[2]*(.5*a.x+.5),o[1]+o[3]*(.5*a.y+.5),.5*a.z+.5)},w.unProject=function(r,n,i,o,a,u){o=o||w.modelviewMatrix,a=a||w.projectionMatrix,u=u||w.getParameter(w.VIEWPORT);var f=new y((r-u[0])/u[2]*2-1,(n-u[1])/u[3]*2-1,2*i-1);return s.inverse(s.multiply(a,o,t),e).transformPoint(f)},w.matrixMode(w.MODELVIEW)}function e(){var t={mesh:new c({coords:!0,colors:!0,triangles:!1}),mode:-1,coord:[0,0,0,0],color:[1,1,1,1],pointSize:1,shader:new v("      uniform float pointSize;      varying vec4 color;      varying vec4 coord;      void main() {        color = gl_Color;        coord = gl_TexCoord;        gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;        gl_PointSize = pointSize;      }    ","      uniform sampler2D texture;      uniform float pointSize;      uniform bool useTexture;      varying vec4 color;      varying vec4 coord;      void main() {        gl_FragColor = color;        if (useTexture) gl_FragColor *= texture2D(texture, coord.xy);      }    ")};w.pointSize=function(e){t.shader.uniforms({pointSize:e})},w.begin=function(e){if(t.mode!=-1)throw new Error("mismatched gl.begin() and gl.end() calls");t.mode=e,t.mesh.colors=[],t.mesh.coords=[],t.mesh.vertices=[]},w.color=function(e,r,n,i){t.color=1==arguments.length?e.toArray().concat(1):[e,r,n,i||1]},w.texCoord=function(e,r){t.coord=1==arguments.length?e.toArray(2):[e,r]},w.vertex=function(e,r,n){t.mesh.colors.push(t.color),t.mesh.coords.push(t.coord),t.mesh.vertices.push(1==arguments.length?e.toArray():[e,r,n])},w.end=function(){if(t.mode==-1)throw new Error("mismatched gl.begin() and gl.end() calls");t.mesh.compile(),t.shader.uniforms({useTexture:!!w.getParameter(w.TEXTURE_BINDING_2D)}).draw(t.mesh,t.mode),t.mode=-1}}function r(){function t(){for(var t in l)if(d.call(l,t)&&l[t])return!0;return!1}function e(e){var r={};for(var n in e)"function"==typeof e[n]?r[n]=function(t){return function(){t.apply(e,arguments)}}(e[n]):r[n]=e[n];r.original=e,r.x=r.pageX,r.y=r.pageY;for(var i=w.canvas;i;i=i.offsetParent)r.x-=i.offsetLeft,r.y-=i.offsetTop;return m?(r.deltaX=r.x-c,r.deltaY=r.y-h):(r.deltaX=0,r.deltaY=0,m=!0),c=r.x,h=r.y,r.dragging=t(),r.preventDefault=function(){r.original.preventDefault()},r.stopPropagation=function(){r.original.stopPropagation()},r}function r(r){w=f,t()||(i(document,"mousemove",n),i(document,"mouseup",a),o(w.canvas,"mousemove",n),o(w.canvas,"mouseup",a)),l[r.which]=!0,r=e(r),w.onmousedown&&w.onmousedown(r),r.preventDefault()}function n(t){w=f,t=e(t),w.onmousemove&&w.onmousemove(t),t.preventDefault()}function a(r){w=f,l[r.which]=!1,t()||(o(document,"mousemove",n),o(document,"mouseup",a),i(w.canvas,"mousemove",n),i(w.canvas,"mouseup",a)),r=e(r),w.onmouseup&&w.onmouseup(r),r.preventDefault()}function s(){m=!1}function u(){l={},m=!1}var f=w,c=0,h=0,l={},m=!1,d=Object.prototype.hasOwnProperty;i(w.canvas,"mousedown",r),i(w.canvas,"mousemove",n),i(w.canvas,"mouseup",a),i(w.canvas,"mouseover",s),i(w.canvas,"mouseout",s),i(document,"contextmenu",u)}function n(t){var e={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"};return e[t]||(t>=65&&t<=90?String.fromCharCode(t):null)}function i(t,e,r){t.addEventListener(e,r)}function o(t,e,r){t.removeEventListener(e,r)}function a(){!function(t){w.makeCurrent=function(){w=t}}(w),w.animate=function(){function t(){w=n;var i=(new Date).getTime();w.onupdate&&w.onupdate((i-r)/1e3),w.ondraw&&w.ondraw(),e(t),r=i}var e=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){setTimeout(t,1e3/60)},r=(new Date).getTime(),n=w;t()},w.fullscreen=function(t){function e(){w.canvas.width=window.innerWidth-n-o,w.canvas.height=window.innerHeight-r-a,w.viewport(0,0,w.canvas.width,w.canvas.height),!t.camera&&"camera"in t||(w.matrixMode(w.PROJECTION),w.loadIdentity(),w.perspective(t.fov||45,w.canvas.width/w.canvas.height,t.near||.1,t.far||1e3),w.matrixMode(w.MODELVIEW)),w.ondraw&&w.ondraw()}t=t||{};var r=t.paddingTop||0,n=t.paddingLeft||0,o=t.paddingRight||0,a=t.paddingBottom||0;if(!document.body)throw new Error("document.body doesn't exist yet (call gl.fullscreen() from window.onload() or from inside the <body> tag)");document.body.appendChild(w.canvas),document.body.style.overflow="hidden",w.canvas.style.position="absolute",w.canvas.style.left=n+"px",w.canvas.style.top=r+"px",i(window,"resize",e),e()}}function s(){var t=Array.prototype.concat.apply([],arguments);t.length||(t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.m=b?new Float32Array(t):t}function u(){this.unique=[],this.indices=[],this.map={}}function f(t,e){this.buffer=null,this.target=t,this.type=e,this.data=[]}function c(t){t=t||{},this.vertexBuffers={},this.indexBuffers={},this.addVertexBuffer("vertices","gl_Vertex"),t.coords&&this.addVertexBuffer("coords","gl_TexCoord"),t.normals&&this.addVertexBuffer("normals","gl_Normal"),t.colors&&this.addVertexBuffer("colors","gl_Color"),"triangles"in t&&!t.triangles||this.addIndexBuffer("triangles"),t.lines&&this.addIndexBuffer("lines")}function h(t){return new y(2*(1&t)-1,(2&t)-1,(4&t)/2-1)}function l(t,e,r){this.t=arguments.length?t:Number.MAX_VALUE,this.hit=e,this.normal=r}function m(){var t=w.getParameter(w.VIEWPORT),e=w.modelviewMatrix.m,r=new y(e[0],e[4],e[8]),n=new y(e[1],e[5],e[9]),i=new y(e[2],e[6],e[10]),o=new y(e[3],e[7],e[11]);this.eye=new y((-o.dot(r)),(-o.dot(n)),(-o.dot(i)));var a=t[0],s=a+t[2],u=t[1],f=u+t[3];this.ray00=w.unProject(a,u,1).subtract(this.eye),this.ray10=w.unProject(s,u,1).subtract(this.eye),this.ray01=w.unProject(a,f,1).subtract(this.eye),this.ray11=w.unProject(s,f,1).subtract(this.eye),this.viewport=t}function d(t,e,r){for(;null!=(result=t.exec(e));)r(result)}function v(t,e){function r(t){var e=document.getElementById(t);return e?e.text:t}function n(t,e){var r={},n=/^((\s*\/\/.*\n|\s*#extension.*\n)+)[^]*$/.exec(e);return e=n?n[1]+t+e.substr(n[1].length):t+e,d(/\bgl_\w+\b/g,t,function(t){t in r||(e=e.replace(new RegExp("\\b"+t+"\\b","g"),A+t),r[t]=!0)}),e}function i(t,e){var r=w.createShader(t);if(w.shaderSource(r,e),w.compileShader(r),!w.getShaderParameter(r,w.COMPILE_STATUS))throw new Error("compile error: "+w.getShaderInfoLog(r));return r}t=r(t),e=r(e);var o="    uniform mat3 gl_NormalMatrix;    uniform mat4 gl_ModelViewMatrix;    uniform mat4 gl_ProjectionMatrix;    uniform mat4 gl_ModelViewProjectionMatrix;    uniform mat4 gl_ModelViewMatrixInverse;    uniform mat4 gl_ProjectionMatrixInverse;    uniform mat4 gl_ModelViewProjectionMatrixInverse;  ",a=o+"    attribute vec4 gl_Vertex;    attribute vec4 gl_TexCoord;    attribute vec3 gl_Normal;    attribute vec4 gl_Color;    vec4 ftransform() {      return gl_ModelViewProjectionMatrix * gl_Vertex;    }  ",s="    precision highp float;  "+o,u=t+e,f={};if(d(/\b(gl_[^;]*)\b;/g,o,function(t){var e=t[1];if(u.indexOf(e)!=-1){var r=e.replace(/[a-z_]/g,"");f[r]=A+e}}),u.indexOf("ftransform")!=-1&&(f.MVPM=A+"gl_ModelViewProjectionMatrix"),this.usedMatrices=f,t=n(a,t),e=n(s,e),this.program=w.createProgram(),w.attachShader(this.program,i(w.VERTEX_SHADER,t)),w.attachShader(this.program,i(w.FRAGMENT_SHADER,e)),w.linkProgram(this.program),!w.getProgramParameter(this.program,w.LINK_STATUS))throw new Error("link error: "+w.getProgramInfoLog(this.program));this.attributes={},this.uniformLocations={};var c={};d(/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g,t+e,function(t){c[t[2]]=1}),this.isSampler=c}function p(t){var e=Object.prototype.toString.call(t);return"[object Array]"==e||"[object Float32Array]"==e}function g(t){var e=Object.prototype.toString.call(t);return"[object Number]"==e||"[object Boolean]"==e}function x(t,e,r){r=r||{},this.id=w.createTexture(),this.width=t,this.height=e,this.format=r.format||w.RGBA,this.type=r.type||w.UNSIGNED_BYTE;var n=r.filter||r.magFilter||w.LINEAR,i=r.filter||r.minFilter||w.LINEAR;if(this.type===w.FLOAT){if(!x.canUseFloatingPointTextures())throw new Error("OES_texture_float is required but not supported");if((i!==w.NEAREST||n!==w.NEAREST)&&!x.canUseFloatingPointLinearFiltering())throw new Error("OES_texture_float_linear is required but not supported")}w.bindTexture(w.TEXTURE_2D,this.id),w.pixelStorei(w.UNPACK_FLIP_Y_WEBGL,1),w.texParameteri(w.TEXTURE_2D,w.TEXTURE_MAG_FILTER,n),w.texParameteri(w.TEXTURE_2D,w.TEXTURE_MIN_FILTER,i),w.texParameteri(w.TEXTURE_2D,w.TEXTURE_WRAP_S,r.wrap||r.wrapS||w.CLAMP_TO_EDGE),w.texParameteri(w.TEXTURE_2D,w.TEXTURE_WRAP_T,r.wrap||r.wrapT||w.CLAMP_TO_EDGE),w.texImage2D(w.TEXTURE_2D,0,this.format,t,e,0,this.format,this.type,null)}function y(t,e,r){this.x=t||0,this.y=e||0,this.z=r||0}var w,E={create:function(n){n=n||{};var i=document.createElement("canvas");i.width=800,i.height=600,"alpha"in n||(n.alpha=!1);try{w=i.getContext("webgl",n)}catch(t){}try{w=w||i.getContext("experimental-webgl",n)}catch(t){}if(!w)throw new Error("WebGL not supported");return t(),e(),r(),a(),w},keys:{},Matrix:s,Indexer:u,Buffer:f,Mesh:c,HitTest:l,Raytracer:m,Shader:v,Texture:x,Vector:y};i(document,"keydown",function(t){if(!t.altKey&&!t.ctrlKey&&!t.metaKey){var e=n(t.keyCode);e&&(E.keys[e]=!0),E.keys[t.keyCode]=!0}}),i(document,"keyup",function(t){if(!t.altKey&&!t.ctrlKey&&!t.metaKey){var e=n(t.keyCode);e&&(E.keys[e]=!1),E.keys[t.keyCode]=!1}});var M=305397760,b="undefined"!=typeof Float32Array;s.prototype={inverse:function(){return s.inverse(this,new s)},transpose:function(){return s.transpose(this,new s)},multiply:function(t){return s.multiply(this,t,new s)},transformPoint:function(t){var e=this.m;return new y(e[0]*t.x+e[1]*t.y+e[2]*t.z+e[3],e[4]*t.x+e[5]*t.y+e[6]*t.z+e[7],e[8]*t.x+e[9]*t.y+e[10]*t.z+e[11]).divide(e[12]*t.x+e[13]*t.y+e[14]*t.z+e[15])},transformVector:function(t){var e=this.m;return new y(e[0]*t.x+e[1]*t.y+e[2]*t.z,e[4]*t.x+e[5]*t.y+e[6]*t.z,e[8]*t.x+e[9]*t.y+e[10]*t.z)}},s.inverse=function(t,e){e=e||new s;var r=t.m,n=e.m;n[0]=r[5]*r[10]*r[15]-r[5]*r[14]*r[11]-r[6]*r[9]*r[15]+r[6]*r[13]*r[11]+r[7]*r[9]*r[14]-r[7]*r[13]*r[10],n[1]=-r[1]*r[10]*r[15]+r[1]*r[14]*r[11]+r[2]*r[9]*r[15]-r[2]*r[13]*r[11]-r[3]*r[9]*r[14]+r[3]*r[13]*r[10],n[2]=r[1]*r[6]*r[15]-r[1]*r[14]*r[7]-r[2]*r[5]*r[15]+r[2]*r[13]*r[7]+r[3]*r[5]*r[14]-r[3]*r[13]*r[6],n[3]=-r[1]*r[6]*r[11]+r[1]*r[10]*r[7]+r[2]*r[5]*r[11]-r[2]*r[9]*r[7]-r[3]*r[5]*r[10]+r[3]*r[9]*r[6],n[4]=-r[4]*r[10]*r[15]+r[4]*r[14]*r[11]+r[6]*r[8]*r[15]-r[6]*r[12]*r[11]-r[7]*r[8]*r[14]+r[7]*r[12]*r[10],n[5]=r[0]*r[10]*r[15]-r[0]*r[14]*r[11]-r[2]*r[8]*r[15]+r[2]*r[12]*r[11]+r[3]*r[8]*r[14]-r[3]*r[12]*r[10],n[6]=-r[0]*r[6]*r[15]+r[0]*r[14]*r[7]+r[2]*r[4]*r[15]-r[2]*r[12]*r[7]-r[3]*r[4]*r[14]+r[3]*r[12]*r[6],n[7]=r[0]*r[6]*r[11]-r[0]*r[10]*r[7]-r[2]*r[4]*r[11]+r[2]*r[8]*r[7]+r[3]*r[4]*r[10]-r[3]*r[8]*r[6],n[8]=r[4]*r[9]*r[15]-r[4]*r[13]*r[11]-r[5]*r[8]*r[15]+r[5]*r[12]*r[11]+r[7]*r[8]*r[13]-r[7]*r[12]*r[9],n[9]=-r[0]*r[9]*r[15]+r[0]*r[13]*r[11]+r[1]*r[8]*r[15]-r[1]*r[12]*r[11]-r[3]*r[8]*r[13]+r[3]*r[12]*r[9],n[10]=r[0]*r[5]*r[15]-r[0]*r[13]*r[7]-r[1]*r[4]*r[15]+r[1]*r[12]*r[7]+r[3]*r[4]*r[13]-r[3]*r[12]*r[5],n[11]=-r[0]*r[5]*r[11]+r[0]*r[9]*r[7]+r[1]*r[4]*r[11]-r[1]*r[8]*r[7]-r[3]*r[4]*r[9]+r[3]*r[8]*r[5],n[12]=-r[4]*r[9]*r[14]+r[4]*r[13]*r[10]+r[5]*r[8]*r[14]-r[5]*r[12]*r[10]-r[6]*r[8]*r[13]+r[6]*r[12]*r[9],n[13]=r[0]*r[9]*r[14]-r[0]*r[13]*r[10]-r[1]*r[8]*r[14]+r[1]*r[12]*r[10]+r[2]*r[8]*r[13]-r[2]*r[12]*r[9],n[14]=-r[0]*r[5]*r[14]+r[0]*r[13]*r[6]+r[1]*r[4]*r[14]-r[1]*r[12]*r[6]-r[2]*r[4]*r[13]+r[2]*r[12]*r[5],n[15]=r[0]*r[5]*r[10]-r[0]*r[9]*r[6]-r[1]*r[4]*r[10]+r[1]*r[8]*r[6]+r[2]*r[4]*r[9]-r[2]*r[8]*r[5];for(var i=r[0]*n[0]+r[1]*n[4]+r[2]*n[8]+r[3]*n[12],o=0;o<16;o++)n[o]/=i;return e},s.transpose=function(t,e){e=e||new s;var r=t.m,n=e.m;return n[0]=r[0],n[1]=r[4],n[2]=r[8],n[3]=r[12],n[4]=r[1],n[5]=r[5],n[6]=r[9],n[7]=r[13],n[8]=r[2],n[9]=r[6],n[10]=r[10],n[11]=r[14],n[12]=r[3],n[13]=r[7],n[14]=r[11],n[15]=r[15],e},s.multiply=function(t,e,r){r=r||new s;var n=t.m,i=e.m,o=r.m;return o[0]=n[0]*i[0]+n[1]*i[4]+n[2]*i[8]+n[3]*i[12],o[1]=n[0]*i[1]+n[1]*i[5]+n[2]*i[9]+n[3]*i[13],o[2]=n[0]*i[2]+n[1]*i[6]+n[2]*i[10]+n[3]*i[14],o[3]=n[0]*i[3]+n[1]*i[7]+n[2]*i[11]+n[3]*i[15],o[4]=n[4]*i[0]+n[5]*i[4]+n[6]*i[8]+n[7]*i[12],o[5]=n[4]*i[1]+n[5]*i[5]+n[6]*i[9]+n[7]*i[13],o[6]=n[4]*i[2]+n[5]*i[6]+n[6]*i[10]+n[7]*i[14],o[7]=n[4]*i[3]+n[5]*i[7]+n[6]*i[11]+n[7]*i[15],o[8]=n[8]*i[0]+n[9]*i[4]+n[10]*i[8]+n[11]*i[12],o[9]=n[8]*i[1]+n[9]*i[5]+n[10]*i[9]+n[11]*i[13],o[10]=n[8]*i[2]+n[9]*i[6]+n[10]*i[10]+n[11]*i[14],o[11]=n[8]*i[3]+n[9]*i[7]+n[10]*i[11]+n[11]*i[15],o[12]=n[12]*i[0]+n[13]*i[4]+n[14]*i[8]+n[15]*i[12],o[13]=n[12]*i[1]+n[13]*i[5]+n[14]*i[9]+n[15]*i[13],o[14]=n[12]*i[2]+n[13]*i[6]+n[14]*i[10]+n[15]*i[14],o[15]=n[12]*i[3]+n[13]*i[7]+n[14]*i[11]+n[15]*i[15],r},s.identity=function(t){t=t||new s;var e=t.m;return e[0]=e[5]=e[10]=e[15]=1,e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,t},s.perspective=function(t,e,r,n,i){var o=Math.tan(t*Math.PI/360)*r,a=o*e;return s.frustum(-a,a,-o,o,r,n,i)},s.frustum=function(t,e,r,n,i,o,a){a=a||new s;var u=a.m;return u[0]=2*i/(e-t),u[1]=0,u[2]=(e+t)/(e-t),u[3]=0,u[4]=0,u[5]=2*i/(n-r),u[6]=(n+r)/(n-r),u[7]=0,u[8]=0,u[9]=0,u[10]=-(o+i)/(o-i),u[11]=-2*o*i/(o-i),u[12]=0,u[13]=0,u[14]=-1,u[15]=0,a},s.ortho=function(t,e,r,n,i,o,a){a=a||new s;var u=a.m;return u[0]=2/(e-t),u[1]=0,u[2]=0,u[3]=-(e+t)/(e-t),u[4]=0,u[5]=2/(n-r),u[6]=0,u[7]=-(n+r)/(n-r),u[8]=0,u[9]=0,u[10]=-2/(o-i),u[11]=-(o+i)/(o-i),u[12]=0,u[13]=0,u[14]=0,u[15]=1,a},s.scale=function(t,e,r,n){n=n||new s;var i=n.m;return i[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=r,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,n},s.translate=function(t,e,r,n){n=n||new s;var i=n.m;return i[0]=1,i[1]=0,i[2]=0,i[3]=t,i[4]=0,i[5]=1,i[6]=0,i[7]=e,i[8]=0,i[9]=0,i[10]=1,i[11]=r,i[12]=0,i[13]=0,i[14]=0,i[15]=1,n},s.rotate=function(t,e,r,n,i){if(!t||!e&&!r&&!n)return s.identity(i);i=i||new s;var o=i.m,a=Math.sqrt(e*e+r*r+n*n);t*=Math.PI/180,e/=a,r/=a,n/=a;var u=Math.cos(t),f=Math.sin(t),c=1-u;return o[0]=e*e*c+u,o[1]=e*r*c-n*f,o[2]=e*n*c+r*f,o[3]=0,o[4]=r*e*c+n*f,o[5]=r*r*c+u,o[6]=r*n*c-e*f,o[7]=0,o[8]=n*e*c-r*f,o[9]=n*r*c+e*f,o[10]=n*n*c+u,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,i},s.lookAt=function(t,e,r,n,i,o,a,u,f,c){c=c||new s;var h=c.m,l=new y(t,e,r),m=new y(n,i,o),d=new y(a,u,f),v=l.subtract(m).unit(),p=d.cross(v).unit(),g=v.cross(p).unit();return h[0]=p.x,h[1]=p.y,h[2]=p.z,h[3]=-p.dot(l),h[4]=g.x,h[5]=g.y,h[6]=g.z,h[7]=-g.dot(l),h[8]=v.x,h[9]=v.y,h[10]=v.z,h[11]=-v.dot(l),h[12]=0,h[13]=0,h[14]=0,h[15]=1,c},u.prototype={add:function(t){var e=JSON.stringify(t);return e in this.map||(this.map[e]=this.unique.length,this.unique.push(t)),this.map[e]}},f.prototype={compile:function(t){for(var e=[],r=0,n=1e4;r<this.data.length;r+=n)e=Array.prototype.concat.apply(e,this.data.slice(r,r+n));var i=this.data.length?e.length/this.data.length:0;if(i!=Math.round(i))throw new Error("buffer elements not of consistent size, average size is "+i);this.buffer=this.buffer||w.createBuffer(),this.buffer.length=e.length,this.buffer.spacing=i,w.bindBuffer(this.target,this.buffer),w.bufferData(this.target,new this.type(e),t||w.STATIC_DRAW)}},c.prototype={addVertexBuffer:function(t,e){var r=this.vertexBuffers[e]=new f(w.ARRAY_BUFFER,Float32Array);r.name=t,this[t]=[]},addIndexBuffer:function(t){this.indexBuffers[t]=new f(w.ELEMENT_ARRAY_BUFFER,Uint16Array),this[t]=[]},compile:function(){for(var t in this.vertexBuffers){var e=this.vertexBuffers[t];e.data=this[e.name],e.compile()}for(var r in this.indexBuffers){var e=this.indexBuffers[r];e.data=this[r],e.compile()}},transform:function(t){if(this.vertices=this.vertices.map(function(e){return t.transformPoint(y.fromArray(e)).toArray()}),this.normals){var e=t.inverse().transpose();this.normals=this.normals.map(function(t){return e.transformVector(y.fromArray(t)).unit().toArray()})}return this.compile(),this},computeNormals:function(){this.normals||this.addVertexBuffer("normals","gl_Normal");for(var t=0;t<this.vertices.length;t++)this.normals[t]=new y;for(var t=0;t<this.triangles.length;t++){var e=this.triangles[t],r=y.fromArray(this.vertices[e[0]]),n=y.fromArray(this.vertices[e[1]]),i=y.fromArray(this.vertices[e[2]]),o=n.subtract(r).cross(i.subtract(r)).unit();this.normals[e[0]]=this.normals[e[0]].add(o),this.normals[e[1]]=this.normals[e[1]].add(o),this.normals[e[2]]=this.normals[e[2]].add(o)}for(var t=0;t<this.vertices.length;t++)this.normals[t]=this.normals[t].unit().toArray();return this.compile(),this},computeWireframe:function(){for(var t=new u,e=0;e<this.triangles.length;e++)for(var r=this.triangles[e],n=0;n<r.length;n++){var i=r[n],o=r[(n+1)%r.length];t.add([Math.min(i,o),Math.max(i,o)])}return this.lines||this.addIndexBuffer("lines"),this.lines=t.unique,this.compile(),this},getAABB:function(){var t={min:new y(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};t.max=t.min.negative();for(var e=0;e<this.vertices.length;e++){var r=y.fromArray(this.vertices[e]);t.min=y.min(t.min,r),t.max=y.max(t.max,r)}return t},getBoundingSphere:function(){for(var t=this.getAABB(),e={center:t.min.add(t.max).divide(2),radius:0},r=0;r<this.vertices.length;r++)e.radius=Math.max(e.radius,y.fromArray(this.vertices[r]).subtract(e.center).length());return e}},c.plane=function(t){t=t||{};var e=new c(t);detailX=t.detailX||t.detail||1,detailY=t.detailY||t.detail||1;for(var r=0;r<=detailY;r++)for(var n=r/detailY,i=0;i<=detailX;i++){var o=i/detailX;if(e.vertices.push([2*o-1,2*n-1,0]),e.coords&&e.coords.push([o,n]),e.normals&&e.normals.push([0,0,1]),i<detailX&&r<detailY){var a=i+r*(detailX+1);e.triangles.push([a,a+1,a+detailX+1]),e.triangles.push([a+detailX+1,a+1,a+detailX+2])}}return e.compile(),e};var T=[[0,4,2,6,-1,0,0],[1,3,5,7,1,0,0],[0,1,4,5,0,-1,0],[2,6,3,7,0,1,0],[0,2,1,3,0,0,-1],[4,5,6,7,0,0,1]];c.cube=function(t){for(var e=new c(t),r=0;r<T.length;r++){for(var n=T[r],i=4*r,o=0;o<4;o++){var a=n[o];e.vertices.push(h(a).toArray()),e.coords&&e.coords.push([1&o,(2&o)/2]),e.normals&&e.normals.push(n.slice(4,7))}e.triangles.push([i,i+1,i+2]),e.triangles.push([i+2,i+1,i+3])}return e.compile(),e},c.sphere=function(t){function e(t,e,r){return s?[t,r,e]:[t,e,r]}function r(t){return t+(t-t*t)/2}t=t||{};var n=new c(t),i=new u;detail=t.detail||6;for(var o=0;o<8;o++)for(var a=h(o),s=a.x*a.y*a.z>0,f=[],l=0;l<=detail;l++){for(var m=0;l+m<=detail;m++){var d=l/detail,v=m/detail,p=(detail-l-m)/detail,g={vertex:new y(r(d),r(v),r(p)).unit().multiply(a).toArray()};n.coords&&(g.coord=a.y>0?[1-d,p]:[p,1-d]),f.push(i.add(g))}if(l>0)for(var m=0;l+m<=detail;m++){var d=(l-1)*(detail+1)+(l-1-(l-1)*(l-1))/2+m,v=l*(detail+1)+(l-l*l)/2+m;n.triangles.push(e(f[d],f[d+1],f[v])),l+m<detail&&n.triangles.push(e(f[v],f[d+1],f[v+1]))}}return n.vertices=i.unique.map(function(t){return t.vertex}),n.coords&&(n.coords=i.unique.map(function(t){return t.coord})),n.normals&&(n.normals=n.vertices),n.compile(),n},c.load=function(t,e){e=e||{},"coords"in e||(e.coords=!!t.coords),"normals"in e||(e.normals=!!t.normals),"colors"in e||(e.colors=!!t.colors),"triangles"in e||(e.triangles=!!t.triangles),"lines"in e||(e.lines=!!t.lines);var r=new c(e);return r.vertices=t.vertices,r.coords&&(r.coords=t.coords),r.normals&&(r.normals=t.normals),r.colors&&(r.colors=t.colors),r.triangles&&(r.triangles=t.triangles),r.lines&&(r.lines=t.lines),r.compile(),r},l.prototype={mergeWith:function(t){t.t>0&&t.t<this.t&&(this.t=t.t,this.hit=t.hit,this.normal=t.normal)}},m.prototype={getRayForPixel:function(t,e){t=(t-this.viewport[0])/this.viewport[2],e=1-(e-this.viewport[1])/this.viewport[3];var r=y.lerp(this.ray00,this.ray10,t),n=y.lerp(this.ray01,this.ray11,t);return y.lerp(r,n,e).unit()}},m.hitTestBox=function(t,e,r,n){var i=r.subtract(t).divide(e),o=n.subtract(t).divide(e),a=y.min(i,o),s=y.max(i,o),u=a.max(),f=s.min();if(u>0&&u<f){var c=1e-6,h=t.add(e.multiply(u));return r=r.add(c),n=n.subtract(c),new l(u,h,new y((h.x>n.x)-(h.x<r.x),(h.y>n.y)-(h.y<r.y),(h.z>n.z)-(h.z<r.z)))}return null},m.hitTestSphere=function(t,e,r,n){var i=t.subtract(r),o=e.dot(e),a=2*e.dot(i),s=i.dot(i)-n*n,u=a*a-4*o*s;if(u>0){var f=(-a-Math.sqrt(u))/(2*o),c=t.add(e.multiply(f));return new l(f,c,c.subtract(r).divide(n))}return null},m.hitTestTriangle=function(t,e,r,n,i){var o=n.subtract(r),a=i.subtract(r),s=o.cross(a).unit(),u=s.dot(r.subtract(t))/s.dot(e);if(u>0){var f=t.add(e.multiply(u)),c=f.subtract(r),h=a.dot(a),m=a.dot(o),d=a.dot(c),v=o.dot(o),p=o.dot(c),g=h*v-m*m,x=(v*d-m*p)/g,y=(h*p-m*d)/g;if(x>=0&&y>=0&&x+y<=1)return new l(u,f,s)}return null};var A="LIGHTGL";new s,new s,v.prototype={uniforms:function(t){w.useProgram(this.program);for(var e in t){var r=this.uniformLocations[e]||w.getUniformLocation(this.program,e);if(r){this.uniformLocations[e]=r;var n=t[e];if(n instanceof y?n=[n.x,n.y,n.z]:n instanceof s&&(n=n.m),p(n))switch(n.length){case 1:w.uniform1fv(r,new Float32Array(n));break;case 2:w.uniform2fv(r,new Float32Array(n));break;case 3:w.uniform3fv(r,new Float32Array(n));break;case 4:w.uniform4fv(r,new Float32Array(n));break;case 9:w.uniformMatrix3fv(r,!1,new Float32Array([n[0],n[3],n[6],n[1],n[4],n[7],n[2],n[5],n[8]]));break;case 16:w.uniformMatrix4fv(r,!1,new Float32Array([n[0],n[4],n[8],n[12],n[1],n[5],n[9],n[13],n[2],n[6],n[10],n[14],n[3],n[7],n[11],n[15]]));break;default:throw new Error("don't know how to load uniform \""+e+'" of length '+n.length)}else{if(!g(n))throw new Error('attempted to set uniform "'+e+'" to invalid value '+n);(this.isSampler[e]?w.uniform1i:w.uniform1f).call(w,r,n)}}}return this},draw:function(t,e){this.drawBuffers(t.vertexBuffers,t.indexBuffers[e==w.LINES?"lines":"triangles"],arguments.length<2?w.TRIANGLES:e)},drawBuffers:function(t,e,r){var n=this.usedMatrices,i=w.modelviewMatrix,o=w.projectionMatrix,a=n.MVMI||n.NM?i.inverse():null,s=n.PMI?o.inverse():null,u=n.MVPM||n.MVPMI?o.multiply(i):null,f={};if(n.MVM&&(f[n.MVM]=i),n.MVMI&&(f[n.MVMI]=a),n.PM&&(f[n.PM]=o),n.PMI&&(f[n.PMI]=s),n.MVPM&&(f[n.MVPM]=u),n.MVPMI&&(f[n.MVPMI]=u.inverse()),n.NM){var c=a.m;f[n.NM]=[c[0],c[4],c[8],c[1],c[5],c[9],c[2],c[6],c[10]]}this.uniforms(f);var h=0;for(var l in t){var m=t[l],d=this.attributes[l]||w.getAttribLocation(this.program,l.replace(/^(gl_.*)$/,A+"$1"));d!=-1&&m.buffer&&(this.attributes[l]=d,w.bindBuffer(w.ARRAY_BUFFER,m.buffer),w.enableVertexAttribArray(d),w.vertexAttribPointer(d,m.buffer.spacing,w.FLOAT,!1,0,0),h=m.buffer.length/m.buffer.spacing)}for(var l in this.attributes)l in t||w.disableVertexAttribArray(this.attributes[l]);return!h||e&&!e.buffer||(e?(w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,e.buffer),w.drawElements(r,e.buffer.length,w.UNSIGNED_SHORT,0)):w.drawArrays(r,0,h)),this}};var R,F,_;return x.prototype={bind:function(t){w.activeTexture(w.TEXTURE0+(t||0)),w.bindTexture(w.TEXTURE_2D,this.id)},unbind:function(t){w.activeTexture(w.TEXTURE0+(t||0)),w.bindTexture(w.TEXTURE_2D,null)},canDrawTo:function(){R=R||w.createFramebuffer(),w.bindFramebuffer(w.FRAMEBUFFER,R),w.framebufferTexture2D(w.FRAMEBUFFER,w.COLOR_ATTACHMENT0,w.TEXTURE_2D,this.id,0);var t=w.checkFramebufferStatus(w.FRAMEBUFFER)==w.FRAMEBUFFER_COMPLETE;return w.bindFramebuffer(w.FRAMEBUFFER,null),t},drawTo:function(t){var e=w.getParameter(w.VIEWPORT);if(R=R||w.createFramebuffer(),F=F||w.createRenderbuffer(),w.bindFramebuffer(w.FRAMEBUFFER,R),w.bindRenderbuffer(w.RENDERBUFFER,F),this.width==F.width&&this.height==F.height||(F.width=this.width,F.height=this.height,w.renderbufferStorage(w.RENDERBUFFER,w.DEPTH_COMPONENT16,this.width,this.height)),w.framebufferTexture2D(w.FRAMEBUFFER,w.COLOR_ATTACHMENT0,w.TEXTURE_2D,this.id,0),w.framebufferRenderbuffer(w.FRAMEBUFFER,w.DEPTH_ATTACHMENT,w.RENDERBUFFER,F),w.checkFramebufferStatus(w.FRAMEBUFFER)!=w.FRAMEBUFFER_COMPLETE)throw new Error("Rendering to this texture is not supported (incomplete framebuffer)");w.viewport(0,0,this.width,this.height),t(),w.bindFramebuffer(w.FRAMEBUFFER,null),w.bindRenderbuffer(w.RENDERBUFFER,null),w.viewport(e[0],e[1],e[2],e[3])},swapWith:function(t){var e;e=t.id,t.id=this.id,this.id=e,e=t.width,t.width=this.width,this.width=e,e=t.height,t.height=this.height,this.height=e}},x.fromImage=function(t,e){e=e||{};var r=new x(t.width,t.height,e);try{w.texImage2D(w.TEXTURE_2D,0,r.format,r.format,r.type,t)}catch(t){throw"file:"==location.protocol?new Error('image not loaded for security reasons (serve this page over "http://" instead)'):new Error("image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)")}return e.minFilter&&e.minFilter!=w.NEAREST&&e.minFilter!=w.LINEAR&&w.generateMipmap(w.TEXTURE_2D),r},x.fromURL=function(t,e){_=_||function(){var t=document.createElement("canvas").getContext("2d");t.canvas.width=t.canvas.height=128;for(var e=0;e<t.canvas.height;e+=16)for(var r=0;r<t.canvas.width;r+=16)t.fillStyle=16&(r^e)?"#FFF":"#DDD",t.fillRect(r,e,16,16);return t.canvas}();var r=x.fromImage(_,e),n=new Image,i=w;return n.onload=function(){i.makeCurrent(),x.fromImage(n,e).swapWith(r)},n.src=t,r},x.canUseFloatingPointTextures=function(){return!!w.getExtension("OES_texture_float")},x.canUseFloatingPointLinearFiltering=function(){return!!w.getExtension("OES_texture_float_linear")},y.prototype={negative:function(){return new y((-this.x),(-this.y),(-this.z))},add:function(t){return t instanceof y?new y(this.x+t.x,this.y+t.y,this.z+t.z):new y(this.x+t,this.y+t,this.z+t)},subtract:function(t){return t instanceof y?new y(this.x-t.x,this.y-t.y,this.z-t.z):new y(this.x-t,this.y-t,this.z-t)},multiply:function(t){return t instanceof y?new y(this.x*t.x,this.y*t.y,this.z*t.z):new y(this.x*t,this.y*t,this.z*t)},divide:function(t){return t instanceof y?new y(this.x/t.x,this.y/t.y,this.z/t.z):new y(this.x/t,this.y/t,this.z/t)},equals:function(t){return this.x==t.x&&this.y==t.y&&this.z==t.z},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},cross:function(t){return new y(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},length:function(){return Math.sqrt(this.dot(this))},unit:function(){return this.divide(this.length())},min:function(){return Math.min(Math.min(this.x,this.y),this.z)},max:function(){return Math.max(Math.max(this.x,this.y),this.z)},toAngles:function(){return{theta:Math.atan2(this.z,this.x),phi:Math.asin(this.y/this.length())}},toArray:function(t){return[this.x,this.y,this.z].slice(0,t||3)},clone:function(){return new y(this.x,this.y,this.z)},init:function(t,e,r){return this.x=t,this.y=e,this.z=r,this}},y.negative=function(t,e){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},y.add=function(t,e,r){return e instanceof y?(r.x=t.x+e.x,r.y=t.y+e.y,r.z=t.z+e.z):(r.x=t.x+e,r.y=t.y+e,r.z=t.z+e),r},y.subtract=function(t,e,r){return e instanceof y?(r.x=t.x-e.x,r.y=t.y-e.y,r.z=t.z-e.z):(r.x=t.x-e,r.y=t.y-e,r.z=t.z-e),r},y.multiply=function(t,e,r){return e instanceof y?(r.x=t.x*e.x,r.y=t.y*e.y,r.z=t.z*e.z):(r.x=t.x*e,r.y=t.y*e,r.z=t.z*e),r},y.divide=function(t,e,r){return e instanceof y?(r.x=t.x/e.x,r.y=t.y/e.y,r.z=t.z/e.z):(r.x=t.x/e,r.y=t.y/e,r.z=t.z/e),r},y.cross=function(t,e,r){return r.x=t.y*e.z-t.z*e.y,r.y=t.z*e.x-t.x*e.z,r.z=t.x*e.y-t.y*e.x,r},y.unit=function(t,e){var r=t.length();return e.x=t.x/r,e.y=t.y/r,e.z=t.z/r,e},y.fromAngles=function(t,e){return new y(Math.cos(t)*Math.cos(e),Math.sin(e),Math.sin(t)*Math.cos(e))},y.randomDirection=function(){return y.fromAngles(Math.random()*Math.PI*2,Math.asin(2*Math.random()-1))},y.min=function(t,e){return new y(Math.min(t.x,e.x),Math.min(t.y,e.y),Math.min(t.z,e.z))},y.max=function(t,e){return new y(Math.max(t.x,e.x),Math.max(t.y,e.y),Math.max(t.z,e.z))},y.lerp=function(t,e,r){return e.subtract(t).multiply(r).add(t)},y.fromArray=function(t){return new y(t[0],t[1],t[2])},E}();